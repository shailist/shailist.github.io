<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Python Source Preprocessor (Custom Encoding)" /><meta property="og:locale" content="en" /><meta name="description" content="Although you can pretty much do anything with the Python programming language, source code manipulation and metaprogramming isn’t really a thing. In this article we are going to look at how we can make preprocess python source files and add our extensions to the language’s syntax." /><meta property="og:description" content="Although you can pretty much do anything with the Python programming language, source code manipulation and metaprogramming isn’t really a thing. In this article we are going to look at how we can make preprocess python source files and add our extensions to the language’s syntax." /><link rel="canonical" href="https://shailist.github.io/posts/python-source-preprocessor-custom-encoding/" /><meta property="og:url" content="https://shailist.github.io/posts/python-source-preprocessor-custom-encoding/" /><meta property="og:site_name" content="shailist" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-02T23:53:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Python Source Preprocessor (Custom Encoding)" /><meta name="twitter:site" content="@shai_list" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-03T00:27:16+03:00","datePublished":"2022-09-02T23:53:00+03:00","description":"Although you can pretty much do anything with the Python programming language, source code manipulation and metaprogramming isn’t really a thing. In this article we are going to look at how we can make preprocess python source files and add our extensions to the language’s syntax.","headline":"Python Source Preprocessor (Custom Encoding)","mainEntityOfPage":{"@type":"WebPage","@id":"https://shailist.github.io/posts/python-source-preprocessor-custom-encoding/"},"url":"https://shailist.github.io/posts/python-source-preprocessor-custom-encoding/"}</script><title>Python Source Preprocessor (Custom Encoding) | shailist</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="shailist"><meta name="application-name" content="shailist"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">shailist</a></div><div class="site-subtitle font-italic">Programming & stuff</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/shailist" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/shai_list" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['shailist2000','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Python Source Preprocessor (Custom Encoding)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Python Source Preprocessor (Custom Encoding)</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1662151980" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 2, 2022 </em> </span> <span> Updated <em class="" data-ts="1662154036" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 3, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/shai_list">Shai List</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1474 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p>Although you can pretty much do anything with the Python programming language, source code manipulation and metaprogramming isn’t really a thing.<br /> In this article we are going to look at how we can make preprocess python source files and add our extensions to the language’s syntax.</p><p>All the code used in this post and more can be found here:<br /> <a href="https://github.com/shailist/python-preprocessor/" target="_blank">https://github.com/shailist/python-preprocessor</a></p><h1 id="example-usage">Example Usage</h1><p>I wanted to implement a “vault” in python. That is, a python source file that can only used or accessed with the correct password.<br /> The password will be set using <code class="language-plaintext highlighter-rouge">#set_password</code>, and the protected area will be declared between <code class="language-plaintext highlighter-rouge">#vault_start</code> and <code class="language-plaintext highlighter-rouge">#vault_end</code>.<br /> To give an idea of what we are going to implement, lets look at an example:</p><div file="secret.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="secret.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1"># coding: vault
</span>
<span class="k">print</span><span class="p">(</span><span class="s">"I wonder what's inside..."</span><span class="p">)</span>

<span class="c1">#vault_start
</span><span class="o">++</span><span class="n">lIZKsJQrv2pSIrhHAo9WGnOAEM</span><span class="o">+</span><span class="n">enhVW</span><span class="o">/</span><span class="n">V9il</span><span class="o">/</span><span class="n">HoKpaWjNLLAeSdqeveneqcJ</span><span class="o">+</span>
<span class="c1">#vault_end
</span>
</pre></table></code></div></div><p>And to access the protected area:</p><div file="main.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="main.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1"># coding: vault
</span>
<span class="c1">#set_password S3c4et!
</span><span class="kn">import</span> <span class="nn">secret</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'The flag is: </span><span class="si">{</span><span class="n">secret</span><span class="p">.</span><span class="n">FLAG</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python main.py
I wonder what<span class="s1">'s inside...
The flag is: {c0dIng-1s-Co0l}
</span></pre></table></code></div></div><p>The actual implementation can be found in the sources, but we will look at implementing something much simpler - reversed code:</p><div file="reversed.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="reversed.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1"># coding: reverse-utf-8
</span>
<span class="p">)</span><span class="s">'})01(lairotcaf{ = )01(lairotcaF'</span><span class="n">f</span><span class="p">(</span><span class="n">tnirp</span>

<span class="p">)</span><span class="mi">1</span> <span class="o">-</span> <span class="n">n</span><span class="p">(</span><span class="n">lairotcaf</span> <span class="o">*</span> <span class="n">n</span> <span class="n">nruter</span>    
<span class="mi">1</span> <span class="n">nruter</span>        
<span class="p">:</span><span class="mi">0</span> <span class="o">==</span> <span class="n">n</span> <span class="n">fi</span>    
<span class="p">:)</span><span class="n">n</span><span class="p">(</span><span class="n">lairotcaf</span> <span class="n">fed</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python reversed.py
Factorial<span class="o">(</span>10<span class="o">)</span> <span class="o">=</span> 3628800
</pre></table></code></div></div><h1 id="-coding"># coding</h1><p>The python language allows you to manually specify the encoding of a source file.<br /> In short, if the first or second line of code in your file look something like this:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1"># coding: utf-8
# -*- coding=utf-8 -*-
# This file uses the following encoding: utf-8
</span></pre></table></code></div></div><p>then your source file will be decoded using <code class="language-plaintext highlighter-rouge">utf-8</code>.<br /> The key part is the <code class="language-plaintext highlighter-rouge">coding: &lt;name&gt;</code> pattern, but as you can see the format of this line is very flexible.<br /> You can read more about it inside <a href="https://peps.python.org/pep-0263/">PEP 263</a>.</p><h1 id="registering-a-custom-codec">Registering a Custom Codec</h1><p>When you tell python that you want to encode something with an encoding named <code class="language-plaintext highlighter-rouge">utf-8</code>, how does it know what codec to use?<br /> For some builtin encodings, this process is a part of the implementation, but for other encodings (or custom ones) it works differently.</p><div file="[Python Docs] codecs - Codec registry and base classes" class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="[Python Docs] codecs - Codec registry and base classes"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Custom codecs are made available by registering a suitable codec search function:

codecs.register(search_function)
    Register a codec search function. Search functions are expected to take one argument, being the encoding
    name in all lower case letters with hyphens and spaces converted to underscores, and return a CodecInfo
    object. In case a search function cannot find a given encoding, it should return None.
</pre></table></code></div></div><p>So we can register our own search function, which takes an encoding name as an input, and returns a matching <code class="language-plaintext highlighter-rouge">CodecInfo</code> or <code class="language-plaintext highlighter-rouge">None</code>.<br /> Lets register a custom encoding, which will just be an alias for <code class="language-plaintext highlighter-rouge">utf-8</code>:</p><div file="my_encoding.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="my_encoding.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">codecs</span> <span class="kn">import</span> <span class="n">register</span><span class="p">,</span> <span class="n">lookup</span>

<span class="o">@</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">my_search_function</span><span class="p">(</span><span class="n">encoding_name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">encoding_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">'my_encoding'</span><span class="p">,</span> <span class="s">'my-encoding'</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lookup</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Test'</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'my-encoding'</span><span class="p">))</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python my_encoding.py
b<span class="s1">'Test'</span>
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>One caveat with the <code class="language-plaintext highlighter-rouge">encoding_name</code> we need to be aware of is that starting with Python 3.9 spaces and hyphens in encoding names are replaced with underscores before the lookup.<br /> If we want the backwards compatibility we need to check all of these cases or manually replace these characters, but you can also just pick a single word encoding name ¯\_(ツ)_/¯</p></div></blockquote><h1 id="custom-encoding-101">Custom Encoding 101</h1><p>So we know how to register new encodings, but we still need to implement them.<br /> If we take a look at the <code class="language-plaintext highlighter-rouge">CodecInfo</code> class, we can see what do we need to implement:</p><div file="[Python Docs] codecs - Codec registry and base classes" class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="[Python Docs] codecs - Codec registry and base classes"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>class codecs.CodecInfo(encode, decode, streamreader=None, streamwriter=None,
                       incrementalencoder=None, incrementaldecoder=None, name=None)
    Codec details when looking up the codec registry.
    The constructor arguments are stored in attributes of the same name:

    name
        The name of the encoding.

    encode
    decode
        The stateless encoding and decoding functions. These must be functions or
        methods which have the same interface as the encode() and decode() methods
        of Codec instances (see Codec Interface). The functions or methods are
        expected to work in a stateless mode.
</pre></table></code></div></div><p>As we can see, a codec is defined by its encoding and decoding functions.<br /> Lets implement a the previous encoding, but instead of using the <code class="language-plaintext highlighter-rouge">lookup</code> function, lets build the <code class="language-plaintext highlighter-rouge">CodecInfo</code> ourselves:</p><div file="my_encoding.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="my_encoding.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">codecs</span> <span class="kn">import</span> <span class="n">register</span><span class="p">,</span> <span class="n">CodecInfo</span>
<span class="kn">from</span> <span class="nn">encodings</span> <span class="kn">import</span> <span class="n">utf_8</span>

<span class="o">@</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">my_search_function</span><span class="p">(</span><span class="n">encoding_name</span><span class="p">):</span>
    <span class="c1"># Starting with Python 3.9 hyphens are replaced with an underscores
</span>    <span class="k">if</span> <span class="n">encoding_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">'my_encoding'</span><span class="p">,</span> <span class="s">'my-encoding'</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CodecInfo</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">'my-encoding'</span><span class="p">,</span>
            <span class="n">encode</span><span class="o">=</span><span class="n">utf_8</span><span class="p">.</span><span class="n">encode</span><span class="p">,</span>
            <span class="n">decode</span><span class="o">=</span><span class="n">utf_8</span><span class="p">.</span><span class="n">decode</span>
        <span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Test'</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'my-encoding'</span><span class="p">))</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python my_encoding.py
b<span class="s1">'Test'</span>
</pre></table></code></div></div><p>By implementing our own <code class="language-plaintext highlighter-rouge">encode</code> and <code class="language-plaintext highlighter-rouge">decode</code> functions, we can process the data however we like.<br /> Just as an example, lets define a new encoding called <code class="language-plaintext highlighter-rouge">reverse-utf-8</code>, which will reverse the string before encoding it (and after decoding it):</p><div file="reverse_utf_8.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="reverse_utf_8.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">codecs</span> <span class="kn">import</span> <span class="n">register</span><span class="p">,</span> <span class="n">CodecInfo</span>
<span class="kn">from</span> <span class="nn">encodings</span> <span class="kn">import</span> <span class="n">utf_8</span>

<span class="k">def</span> <span class="nf">reverse_utf_8_encode</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'strict'</span><span class="p">):</span>
    <span class="nb">reversed</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">encoded</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">utf_8</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">reversed</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">encoded</span><span class="p">,</span> <span class="n">size</span>

<span class="k">def</span> <span class="nf">reverse_utf_8_decode</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'strict'</span><span class="p">):</span>
    <span class="n">decoded</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">utf_8</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
    <span class="n">un_reversed</span> <span class="o">=</span> <span class="n">decoded</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">un_reversed</span><span class="p">,</span> <span class="n">size</span>

<span class="o">@</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">search_function</span><span class="p">(</span><span class="n">encoding_name</span><span class="p">):</span>
    <span class="n">encoding_name</span> <span class="o">=</span> <span class="n">encoding_name</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'_'</span><span class="p">,</span> <span class="s">'-'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">encoding_name</span> <span class="ow">in</span> <span class="s">'reverse-utf-8'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CodecInfo</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">'reverse-utf-8'</span><span class="p">,</span>
            <span class="n">encode</span><span class="o">=</span><span class="n">reverse_utf_8_encode</span><span class="p">,</span>
            <span class="n">decode</span><span class="o">=</span><span class="n">reverse_utf_8_decode</span>
        <span class="p">)</span>

<span class="nb">input</span> <span class="o">=</span> <span class="s">'Hello world!'</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="nb">input</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'reverse-utf-8'</span><span class="p">)</span>
<span class="n">decoded</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'reverse-utf-8'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Input: </span><span class="si">{</span><span class="nb">input</span><span class="si">!r}</span><span class="s">'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Encoded: </span><span class="si">{</span><span class="n">encoded</span><span class="si">!r}</span><span class="s">'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Decoded: </span><span class="si">{</span><span class="n">decoded</span><span class="si">!r}</span><span class="s">'</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python reverse_utf_8.py
Input: <span class="s1">'Hello world!'</span>
Encoded: b<span class="s1">'!dlrow olleH'</span>
Decoded: <span class="s1">'Hello world!'</span>
</pre></table></code></div></div><p>You can pretty much do whatever you want in the <code class="language-plaintext highlighter-rouge">encode</code> and <code class="language-plaintext highlighter-rouge">decode</code> functions, but we will stick with simple reversing for now.</p><h1 id="automatic-loading-pth-files">Automatic Loading (PTH Files)</h1><p>Right now we need to make sure our <code class="language-plaintext highlighter-rouge">@register</code>ed function is loaded before we try to use our encoding, but since we want to be able to use the encoding for source files, before they import anything, we need to somehow import our module before the code is decoded. I’m sure there are many ways to do it, but we’ll take a look at <code class="language-plaintext highlighter-rouge">pth</code> files.</p><p>You can look up the documentation for <code class="language-plaintext highlighter-rouge">pth</code> files in the <a href="https://docs.python.org/3/library/site.html">site</a> documentation, but I’ll try to explain the parts that are interesting to us.<br /> If we put a file with the <code class="language-plaintext highlighter-rouge">.pth</code> extension in the <code class="language-plaintext highlighter-rouge">site-packages</code> directory, it will be processed at the startup of the Python environment, before any user code is loaded.<br /> What can <code class="language-plaintext highlighter-rouge">pth</code> files do? Many things, but in particular, if the file begins with <code class="language-plaintext highlighter-rouge">import</code>, its contents are executed as Python code.<br /> We can use this to load our module:</p><div file="reverse_utf_8.pth" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="reverse_utf_8.pth"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">reverse_utf_8</span>
</pre></table></code></div></div><p>Chuck this file into the <code class="language-plaintext highlighter-rouge">site-packages</code> folder and run our reversed file:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python reversed.py
SyntaxError: encoding problem: reverse-utf-8
</pre></table></code></div></div><p>Good luck debugging this error, it is not fun.<br /> The issue is that for source decoding, Python doesn’t use the simple <code class="language-plaintext highlighter-rouge">encode</code> and <code class="language-plaintext highlighter-rouge">decode</code> functions. Instead it uses an incremental decoder.<br /> Taking a look at <code class="language-plaintext highlighter-rouge">utf_8.IncrementalDecoder</code>, we can write our own incremental decoder:</p><div file="reverse_utf_8.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="reverse_utf_8.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="c1"># ...
</span>
<span class="k">class</span> <span class="nc">ReverseUTF8IncrementalDecoder</span><span class="p">(</span><span class="n">utf_8</span><span class="p">.</span><span class="n">IncrementalDecoder</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">buffer</span> <span class="o">+=</span> <span class="nb">input</span>
        
        <span class="k">if</span> <span class="n">final</span><span class="p">:</span>
            <span class="nb">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="nb">buffer</span>
            <span class="bp">self</span><span class="p">.</span><span class="nb">buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span>
            
            <span class="n">decoded</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">reverse_utf_8_decode</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">decoded</span>
        
        <span class="k">return</span> <span class="s">''</span>

<span class="o">@</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">search_function</span><span class="p">(</span><span class="n">encoding_name</span><span class="p">):</span>
    <span class="n">encoding_name</span> <span class="o">=</span> <span class="n">encoding_name</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'_'</span><span class="p">,</span> <span class="s">'-'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">encoding_name</span> <span class="ow">in</span> <span class="s">'reverse-utf-8'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CodecInfo</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">'reverse-utf-8'</span><span class="p">,</span>
            <span class="n">encode</span><span class="o">=</span><span class="n">reverse_utf_8_encode</span><span class="p">,</span>
            <span class="n">decode</span><span class="o">=</span><span class="n">reverse_utf_8_decode</span><span class="p">,</span>
            <span class="n">incrementaldecoder</span><span class="o">=</span><span class="n">ReverseUTF8IncrementalDecoder</span>
        <span class="p">)</span>

<span class="c1"># ...
</span></pre></table></code></div></div><p>We just override the <code class="language-plaintext highlighter-rouge">decode</code> function of the <code class="language-plaintext highlighter-rouge">utf_8.IncrementalDecoder</code> class.<br /> We save every chunk of input that we get until we recieve the <code class="language-plaintext highlighter-rouge">final</code> chunk, and then we just call our decode function and return the result.<br /> We also modified the <code class="language-plaintext highlighter-rouge">search_function</code> to include our <code class="language-plaintext highlighter-rouge">ReverseUTF8IncrementalDecoder</code> in the <code class="language-plaintext highlighter-rouge">CodecInfo</code>.</p><p>Now running our reversed file…</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python reversed.py
Factorial<span class="o">(</span>10<span class="o">)</span> <span class="o">=</span> 3628800
</pre></table></code></div></div><h1 id="note-for-packages">Note for Packages</h1><p>Making the <code class="language-plaintext highlighter-rouge">pth</code> file appear in the <code class="language-plaintext highlighter-rouge">site-packages</code> directory when our package is installed can be a bit troublesome.<br /> I’ve found using the <code class="language-plaintext highlighter-rouge">data_files</code> parameter to work the best:</p><div file="setup.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="setup.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1"># ...
</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">distutils.sysconfig</span> <span class="kn">import</span> <span class="n">get_python_lib</span>

<span class="n">SITE_PACKAGES</span> <span class="o">=</span> <span class="n">get_python_lib</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="c1"># ...
</span>    <span class="n">data_files</span><span class="o">=</span><span class="p">[(</span><span class="n">SITE_PACKAGES</span><span class="p">,</span> <span class="p">[</span><span class="s">'reverse_utf_8.pth'</span><span class="p">])]</span>
<span class="p">)</span>

</pre></table></code></div></div><p>Getting the <code class="language-plaintext highlighter-rouge">site-packages</code> by just using <code class="language-plaintext highlighter-rouge">get_python_lib()</code> isn’t enough, since <code class="language-plaintext highlighter-rouge">wheel</code>s process paths differently.<br /> Converting the path to be relative to the <code class="language-plaintext highlighter-rouge">sys.prefix</code> solves the issue.</p><h1 id="conclusion">Conclusion</h1><p>I had a lot of trouble finding resources on the topics covered in this post, but I think this concept is very cool and can’t wait to see what pepole can come up with using this.<br /> Big thanks to <a href="https://github.com/jonatan1609">@jonatan1609</a> for coming up with the concept and doing the original research, and shoutout to all the people in the forward chain that led me to discovering this :)</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Python+Source+Preprocessor+%28Custom+Encoding%29+-+shailist&url=https%3A%2F%2Fshailist.github.io%2Fposts%2Fpython-source-preprocessor-custom-encoding%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Python+Source+Preprocessor+%28Custom+Encoding%29+-+shailist&u=https%3A%2F%2Fshailist.github.io%2Fposts%2Fpython-source-preprocessor-custom-encoding%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fshailist.github.io%2Fposts%2Fpython-source-preprocessor-custom-encoding%2F&text=Python+Source+Preprocessor+%28Custom+Encoding%29+-+shailist" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/python-source-preprocessor-custom-encoding/">Python Source Preprocessor (Custom Encoding)</a></ul></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div class="post-navigation d-flex justify-content-between"><div class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></div><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/shai_list">Shai List</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
